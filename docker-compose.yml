version: "3.8"

services:
  mutualist:
    container_name: mutualist-web-app
    image: mutualist-web-app:latest
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    restart: always
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8080/api
      - INTERNAL_API_URL=http://mutualist-api:8080/api
    extra_hosts:
      - "localhost:host-gateway"

  mutualist-admin:
    container_name: mutualist-admin
    image: mutualist-admin:latest
    build:
      context: .
      dockerfile: apps/admin/Dockerfile
    ports:
      - "3002:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8080/api
      - INTERNAL_API_URL=http://mutualist-api:8080/api
      - NEXTAUTH_SECRET=supersecretchangeinproduction
      - NEXTAUTH_URL=http://localhost:3002
    depends_on:
      - mutualist-api
    restart: always

  mutualist-api:
    container_name: mutualist-api
    image: mutualist-api:latest
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    ports:
      - "8080:8080"
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/mutualist?schema=public
      - JWT_SECRET=supersecretjwtkeychangeinproduction
      - UPLOAD_DIR=/app/uploads
      - API_BASE_URL=http://localhost:8080
    volumes:
      - ./uploads:/app/uploads
    depends_on:
      - postgres
    restart: always

  prisma-studio:
    container_name: prisma-studio
    image: mutualist-api:latest
    profiles:
      - dev
    ports:
      - "5555:5555"
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/mutualist?schema=public
    command:
      ["bunx", "prisma", "studio", "--port", "5555", "--hostname", "0.0.0.0"]
    depends_on:
      - postgres
    restart: always

  postgres:
    image: postgres:15-alpine
    container_name: postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: mutualist
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: always

volumes:
  postgres_data:
